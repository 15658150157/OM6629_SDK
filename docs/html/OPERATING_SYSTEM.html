<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<!-- BEGIN opengraph metadata -->
<meta property="og:title" content="Doxygen Awesome" />
<meta property="og:image" content="https://repository-images.githubusercontent.com/348492097/4f16df80-88fb-11eb-9d31-4015ff22c452" />
<meta property="og:description" content="Custom CSS theme for doxygen html-documentation with lots of customization parameters." />
<meta property="og:url" content="https://jothepro.github.io/doxygen-awesome-css/" />
<!-- END opengraph metadata -->
<!-- BEGIN twitter metadata -->
<meta name="twitter:image:src" content="https://repository-images.githubusercontent.com/348492097/4f16df80-88fb-11eb-9d31-4015ff22c452" />
<meta name="twitter:title" content="Doxygen Awesome" />
<meta name="twitter:description" content="Custom CSS theme for doxygen html-documentation with lots of customization parameters." />
<!-- END twitter metadata -->
<title>User Guide: Operating System</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" type="image/svg+xml" href="logo.drawio.svg"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/
<a href="https://github.com/jothepro/doxygen-awesome-css" class="github-corner" title="View source on GitHub" target="_blank">
    <svg viewBox="0 0 250 250" width="40" height="40" style="position: absolute; top: 0; border: 0; right: 0; z-index: 99;" aria-hidden="true">
    <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
-->
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">User Guide
   </div>
   <div id="projectbrief">Bluetooth Low Energy 5.4</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('OPERATING_SYSTEM.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Operating System </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_doxygen_source_user_guides_operating_system"></a></p>
<h1><a class="anchor" id="autotoc_md74"></a>
Overview</h1>
<p>Most of the demo projects of this SDK are built on <a href="https://www.freertos.org">FreeRTOS</a>. The Bluetooth part is run in a FreeRTOS thread, and in the thread, there is an efficient event-driven scheduling system.</p>
<p>Of course, the SDK can also remove FreeRTOS and only keep the event-driven scheduling system. This demo is located in <code>SDK/projects/ble_app_simple_nonrtos</code>.</p>
<p>The efficient event-driven Scheduling System, offering the following features:</p><ul>
<li>Event functionality used to defer actions</li>
<li>Timer functionality</li>
<li>Memory management</li>
<li>Simple power manage</li>
<li>Helpful function and macro</li>
</ul>
<h1><a class="anchor" id="autotoc_md75"></a>
FreeRTOS™</h1>
<p>FreeRTOS is real-time operating system for microcontrollers and small microprocessors.</p>
<p>FreeRTOS is a market-leading embedded system RTOS supporting 40+ processor architectures with a small memory footprint, fast execution times, and cutting-edge RTOS features and libraries including Symmetric Multiprocessing (SMP), a thread-safe TCP stack with IPv6 support, and seamless integration with cloud services. It’s open-source and actively supported and maintained.</p>
<p>This document doesn't cover it too much, please click <a href="https://www.freertos.org">here</a> for more information.</p>
<h1><a class="anchor" id="autotoc_md76"></a>
Inside Event-driven Scheduler</h1>
<h2><a class="anchor" id="autotoc_md77"></a>
Overview</h2>
<p>The scheduler is called in the main loop of the background.</p>
<p>In background loop, the Kernel checks if the event field is non-null, and executes the event handlers for which the corresponding event bit is set</p>
<p>The scheduler main loop is shown as follow which is called in <a class="el" href="group__BLE__APP__SIMPLE.html#ga840291bc02cba5474a4cb46a9b9566fe" title="main entry of program">main()</a>.</p>
<div class="fragment"><div class="line"><span class="comment">// Main loop</span></div>
<div class="line"><span class="keywordflow">while</span>(1) {</div>
<div class="line">    <span class="comment">// do event schedule</span></div>
<div class="line">    <a class="code hl_function" href="group__EVT.html#ga5e9d76dd6b10db3022d38f057193fe36">evt_schedule</a>();</div>
<div class="line"> </div>
<div class="line">    OM_CRITICAL_BEGIN();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// if no event, do power manage</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code hl_function" href="group__EVT.html#ga17b20b414c5f1de2f23b87ea0bf5c53f">evt_get_all</a>() == 0) {</div>
<div class="line">        <a class="code hl_function" href="group__PM.html#gaca065483cfe789215a4d194eda3fc931">pm_power_manage</a>();  <span class="comment">// **</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    OM_CRITICAL_END();</div>
<div class="line">}</div>
<div class="ttc" id="agroup__EVT_html_ga17b20b414c5f1de2f23b87ea0bf5c53f"><div class="ttname"><a href="group__EVT.html#ga17b20b414c5f1de2f23b87ea0bf5c53f">evt_get_all</a></div><div class="ttdeci">uint32_t evt_get_all(void)</div><div class="ttdoc">Get all event status.</div></div>
<div class="ttc" id="agroup__EVT_html_ga5e9d76dd6b10db3022d38f057193fe36"><div class="ttname"><a href="group__EVT.html#ga5e9d76dd6b10db3022d38f057193fe36">evt_schedule</a></div><div class="ttdeci">void evt_schedule(void)</div><div class="ttdoc">Event scheduler entry point.</div></div>
<div class="ttc" id="agroup__PM_html_gaca065483cfe789215a4d194eda3fc931"><div class="ttname"><a href="group__PM.html#gaca065483cfe789215a4d194eda3fc931">pm_power_manage</a></div><div class="ttdeci">void pm_power_manage(void)</div><div class="ttdoc">pm power manage, it shall be called in critical section(disable global interrupt)</div></div>
</div><!-- fragment --><p> <em>(**) About <b><a class="el" href="group__PM.html#gaca065483cfe789215a4d194eda3fc931" title="pm power manage, it shall be called in critical section(disable global interrupt)">pm_power_manage()</a></b>, please reference <a class="el" href="POWER_MANAGE.html">Power Manage</a>.</em></p>
<h2><a class="anchor" id="autotoc_md78"></a>
File Structure</h2>
<p>These files and functions placed in the <code>common</code>, <code>components/pm</code>, <code>components/evt</code> folder.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">File   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="evt_8h.html">evt.h</a>   </td><td class="markdownTableBodyNone"><a class="el" href="group__EVT.html">Event-driven scheduler</a>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="evt__timer_8h.html">evt_timer.h</a>   </td><td class="markdownTableBodyNone"><a class="el" href="group__EVT__TIMER.html">Soft timer</a> that is based on hardware 32k timer    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="pm_8h.html">pm.h</a>   </td><td class="markdownTableBodyNone"><a class="el" href="group__PM.html">Simple power management</a>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="om__fifo_8h.html">om_fifo.h</a>, <a class="el" href="om__list_8h.html">om_list.h</a>   </td><td class="markdownTableBodyNone">Basic C structure: <a class="el" href="group__FIFO.html">fifo</a>, <a class="el" href="group__LIST.html">list</a>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="om__time_8h.html">om_time.h</a>   </td><td class="markdownTableBodyNone">System time that is based on haredware 32k timer    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">co_log.h   </td><td class="markdownTableBodyNone">Log system    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">co_utils.h   </td><td class="markdownTableBodyNone">Some helpful function and macro.   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md79"></a>
Priority Management</h2>
<p>The scheduler checks the event field and gets the one with the highest priority. The function below is in charge of finding the event marked with the highest priority set:</p>
<p>evt_ctz();</p>
<p>The event priority depends on its position within the bit field (highest positions have highest priority). The position is defined outside of the kernel source code.</p>
<h2><a class="anchor" id="autotoc_md80"></a>
Useful Function</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Function   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="group__EVT.html#ga8b3b37b758d883c4e2152ff405bf8675">evt_set</a>   </td><td class="markdownTableBodyNone">Set event, Can be called in an interrupt to delay processing something.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="group__EVT.html#ga6585e07fe781b5e1f37b68c2c5883b1a">evt_clear</a>   </td><td class="markdownTableBodyNone">Clear event.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="group__EVT.html#ga91ed2ba8578e3d7d11603a482029b3c0">evt_callback_set</a>   </td><td class="markdownTableBodyNone">Register even callback which is called in main loop with a non-interrupting context   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md81"></a>
Scheduler Source Code</h2>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="group__EVT.html#ga91ed2ba8578e3d7d11603a482029b3c0">evt_callback_set</a>(<a class="code hl_enumeration" href="group__EVT.html#ga40b0d01dd5339e4b8e1c32cb98f0caf3">evt_type_t</a> evt_type, <a class="code hl_typedef" href="group__EVT.html#ga37d1965205e6fc498f39ae4ec45dadb5">evt_callback_t</a> callback)</div>
<div class="line">{</div>
<div class="line">    evt_env.callback[evt_type] = callback;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="group__EVT.html#ga8b3b37b758d883c4e2152ff405bf8675">evt_set</a>(<a class="code hl_enumeration" href="group__EVT.html#ga40b0d01dd5339e4b8e1c32cb98f0caf3">evt_type_t</a> evt_type)</div>
<div class="line">{</div>
<div class="line">    OM_CRITICAL_BEGIN();</div>
<div class="line">    evt_env.field |= (1 &lt;&lt; evt_type);</div>
<div class="line">    OM_CRITICAL_END();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="group__EVT.html#ga6585e07fe781b5e1f37b68c2c5883b1a">evt_clear</a>(<a class="code hl_enumeration" href="group__EVT.html#ga40b0d01dd5339e4b8e1c32cb98f0caf3">evt_type_t</a> evt_type)</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_define" href="group__UTILS.html#ga85d7f601ced158f6eb95d2eb11273416">OM_ASSERT</a>(evt_type &lt; <a class="code hl_enumvalue" href="group__EVT.html#gga40b0d01dd5339e4b8e1c32cb98f0caf3ac3e6ccfc8dc55c46ed3f8322e95737c7">EVT_TYPE_NUM</a>);</div>
<div class="line"> </div>
<div class="line">    OM_CRITICAL_BEGIN();</div>
<div class="line">    evt_env.field &amp;= ~(1u &lt;&lt; evt_type);</div>
<div class="line">    OM_CRITICAL_END();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">uint8_t <a class="code hl_function" href="group__EVT.html#ga5b73e3a2e340ec4ea8fb0b9d906d0de7">evt_get</a>(<a class="code hl_enumeration" href="group__EVT.html#ga40b0d01dd5339e4b8e1c32cb98f0caf3">evt_type_t</a> evt_type)</div>
<div class="line">{</div>
<div class="line">    uint8_t state;</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_define" href="group__UTILS.html#ga85d7f601ced158f6eb95d2eb11273416">OM_ASSERT</a>(evt_type &lt; <a class="code hl_enumvalue" href="group__EVT.html#gga40b0d01dd5339e4b8e1c32cb98f0caf3ac3e6ccfc8dc55c46ed3f8322e95737c7">EVT_TYPE_NUM</a>);</div>
<div class="line"> </div>
<div class="line">    OM_CRITICAL_BEGIN();</div>
<div class="line">    state = (evt_env.field &gt;&gt; evt_type) &amp; 1;</div>
<div class="line">    OM_CRITICAL_END();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> state;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="group__EVT.html#ga5e9d76dd6b10db3022d38f057193fe36">evt_schedule</a>(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Get the volatile value</span></div>
<div class="line">    uint32_t field = evt_env.field;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> (field) { <span class="comment">// Compiler is assumed to optimize with loop inversion</span></div>
<div class="line">        <span class="comment">// Find highest priority event set</span></div>
<div class="line">        uint32_t hdl = evt_ctz(field);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span>(evt_env.callback[hdl] != NULL) {</div>
<div class="line">            <span class="comment">// Execute corresponding handler</span></div>
<div class="line">            <a class="code hl_define" href="group__TRACE.html#gae995f177010dca0677dba2c8b7311b41">TRC_IO</a>(<a class="code hl_enumvalue" href="group__TRACE.html#gga5722eee21509f3d7b78e92de7ae72647a0db6f6adc5f5b681344d0983cb312b1c">TRC_IO_EVT_EXEC_CB</a>, 1);</div>
<div class="line">            (evt_env.callback[hdl])();</div>
<div class="line">            <a class="code hl_define" href="group__TRACE.html#gae995f177010dca0677dba2c8b7311b41">TRC_IO</a>(<a class="code hl_enumvalue" href="group__TRACE.html#gga5722eee21509f3d7b78e92de7ae72647a0db6f6adc5f5b681344d0983cb312b1c">TRC_IO_EVT_EXEC_CB</a>, 0);</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            <a class="code hl_define" href="group__UTILS.html#ga85d7f601ced158f6eb95d2eb11273416">OM_ASSERT</a>(0);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Update the volatile value</span></div>
<div class="line">        field = evt_env.field;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="agroup__EVT_html_ga37d1965205e6fc498f39ae4ec45dadb5"><div class="ttname"><a href="group__EVT.html#ga37d1965205e6fc498f39ae4ec45dadb5">evt_callback_t</a></div><div class="ttdeci">void(* evt_callback_t)(void)</div><div class="ttdoc">Format of an event callback function.</div><div class="ttdef"><b>Definition:</b> evt.h:48</div></div>
<div class="ttc" id="agroup__EVT_html_ga40b0d01dd5339e4b8e1c32cb98f0caf3"><div class="ttname"><a href="group__EVT.html#ga40b0d01dd5339e4b8e1c32cb98f0caf3">evt_type_t</a></div><div class="ttdeci">evt_type_t</div><div class="ttdoc">event type</div><div class="ttdef"><b>Definition:</b> evt.h:51</div></div>
<div class="ttc" id="agroup__EVT_html_ga5b73e3a2e340ec4ea8fb0b9d906d0de7"><div class="ttname"><a href="group__EVT.html#ga5b73e3a2e340ec4ea8fb0b9d906d0de7">evt_get</a></div><div class="ttdeci">uint8_t evt_get(evt_type_t evt_type)</div><div class="ttdoc">Get the status of an event.</div></div>
<div class="ttc" id="agroup__EVT_html_ga6585e07fe781b5e1f37b68c2c5883b1a"><div class="ttname"><a href="group__EVT.html#ga6585e07fe781b5e1f37b68c2c5883b1a">evt_clear</a></div><div class="ttdeci">void evt_clear(evt_type_t evt_type)</div><div class="ttdoc">Clear an event.</div></div>
<div class="ttc" id="agroup__EVT_html_ga8b3b37b758d883c4e2152ff405bf8675"><div class="ttname"><a href="group__EVT.html#ga8b3b37b758d883c4e2152ff405bf8675">evt_set</a></div><div class="ttdeci">void evt_set(evt_type_t evt_type)</div><div class="ttdoc">Set an event.</div></div>
<div class="ttc" id="agroup__EVT_html_ga91ed2ba8578e3d7d11603a482029b3c0"><div class="ttname"><a href="group__EVT.html#ga91ed2ba8578e3d7d11603a482029b3c0">evt_callback_set</a></div><div class="ttdeci">void evt_callback_set(evt_type_t evt_type, evt_callback_t callback)</div><div class="ttdoc">Register an event callback.</div></div>
<div class="ttc" id="agroup__EVT_html_gga40b0d01dd5339e4b8e1c32cb98f0caf3ac3e6ccfc8dc55c46ed3f8322e95737c7"><div class="ttname"><a href="group__EVT.html#gga40b0d01dd5339e4b8e1c32cb98f0caf3ac3e6ccfc8dc55c46ed3f8322e95737c7">EVT_TYPE_NUM</a></div><div class="ttdeci">@ EVT_TYPE_NUM</div><div class="ttdoc">Event number.</div><div class="ttdef"><b>Definition:</b> evt.h:60</div></div>
<div class="ttc" id="agroup__TRACE_html_gae995f177010dca0677dba2c8b7311b41"><div class="ttname"><a href="group__TRACE.html#gae995f177010dca0677dba2c8b7311b41">TRC_IO</a></div><div class="ttdeci">#define TRC_IO(event, is_high)</div><div class="ttdoc">The event is triged, so the IO bonding the event will output is_high state.</div><div class="ttdef"><b>Definition:</b> trc_io.h:71</div></div>
<div class="ttc" id="agroup__TRACE_html_gga5722eee21509f3d7b78e92de7ae72647a0db6f6adc5f5b681344d0983cb312b1c"><div class="ttname"><a href="group__TRACE.html#gga5722eee21509f3d7b78e92de7ae72647a0db6f6adc5f5b681344d0983cb312b1c">TRC_IO_EVT_EXEC_CB</a></div><div class="ttdeci">@ TRC_IO_EVT_EXEC_CB</div><div class="ttdef"><b>Definition:</b> trc_io.h:44</div></div>
<div class="ttc" id="agroup__UTILS_html_ga85d7f601ced158f6eb95d2eb11273416"><div class="ttname"><a href="group__UTILS.html#ga85d7f601ced158f6eb95d2eb11273416">OM_ASSERT</a></div><div class="ttdeci">#define OM_ASSERT(expr)</div><div class="ttdoc">The OM_ASSERT macro is used for function's parameters check.</div><div class="ttdef"><b>Definition:</b> om_utils.h:73</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md82"></a>
Example Code</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#define MY_EVENT_ID     (EVT_TYPE_USR_FIRST+0)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// MY_EVENT_ID event handler (In co_sche and non-interrupting context)</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> user_event_1_handler(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Clear event</span></div>
<div class="line">    <a class="code hl_function" href="group__EVT.html#ga6585e07fe781b5e1f37b68c2c5883b1a">evt_clear</a>(MY_EVENT_ID);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// do something</span></div>
<div class="line">    ......</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// GPIO IRQ handler (interrupting context)</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> my_gpio_handler(<span class="keywordtype">void</span> *om_reg, drv_event_t event, <span class="keywordtype">void</span> *int_status, <span class="keywordtype">void</span> *data)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Trigger event callback to delay process</span></div>
<div class="line">    <a class="code hl_function" href="group__EVT.html#ga8b3b37b758d883c4e2152ff405bf8675">evt_set</a>(MY_EVENT_ID);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="group__BLE__APP__SIMPLE.html#ga840291bc02cba5474a4cb46a9b9566fe">main</a>(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    ......</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// GPIO input init</span></div>
<div class="line">    <a class="code hl_function" href="group__GPIO.html#gaab126e660e5024a5f0992c66cf4b1c4b">drv_gpio_set_trig</a>(OM_GPIO0, BITMASK(10), <a class="code hl_enumvalue" href="group__GPIO.html#ggacb840e4e0c59780df42ed0797e3d58b3a59bfac55a93a36f16c8c0bbced25c4d6">GPIO_TRIG_RISING_FAILING_EDGE</a>);</div>
<div class="line">    <a class="code hl_function" href="group__GPIO.html#gaf8c939f31700c6e92bcd0ff728f8e7af">drv_gpio_register_isr_callback</a>(OM_GPIO0, my_gpio_handler);</div>
<div class="line">    ......</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Register MY_EVENT_ID event</span></div>
<div class="line">    <a class="code hl_function" href="group__EVT.html#ga91ed2ba8578e3d7d11603a482029b3c0">evt_callback_set</a>(MY_EVENT_ID, user_event_1_handler);</div>
<div class="line">    ......</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Main loop</span></div>
<div class="line">    <span class="keywordflow">while</span>(1) {</div>
<div class="line">        <span class="comment">// do event schedule</span></div>
<div class="line">        <a class="code hl_function" href="group__EVT.html#ga5e9d76dd6b10db3022d38f057193fe36">evt_schedule</a>();</div>
<div class="line"> </div>
<div class="line">        OM_CRITICAL_BEGIN();</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// if no event, do power manage</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code hl_function" href="group__EVT.html#ga17b20b414c5f1de2f23b87ea0bf5c53f">evt_get_all</a>() == 0) {</div>
<div class="line">            <a class="code hl_function" href="group__PM.html#gaca065483cfe789215a4d194eda3fc931">pm_power_manage</a>();</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        OM_CRITICAL_END();</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="agroup__BLE__APP__SIMPLE_html_ga840291bc02cba5474a4cb46a9b9566fe"><div class="ttname"><a href="group__BLE__APP__SIMPLE.html#ga840291bc02cba5474a4cb46a9b9566fe">main</a></div><div class="ttdeci">int main(void)</div><div class="ttdoc">main entry of program</div><div class="ttdef"><b>Definition:</b> ble_app_simple.c:142</div></div>
<div class="ttc" id="agroup__GPIO_html_gaab126e660e5024a5f0992c66cf4b1c4b"><div class="ttname"><a href="group__GPIO.html#gaab126e660e5024a5f0992c66cf4b1c4b">drv_gpio_set_trig</a></div><div class="ttdeci">void drv_gpio_set_trig(OM_GPIO_Type *om_gpio, gpio_mask_t gpio_mask, gpio_trig_type_t trig)</div><div class="ttdoc">Set GPIO pin trigger type.</div></div>
<div class="ttc" id="agroup__GPIO_html_gaf8c939f31700c6e92bcd0ff728f8e7af"><div class="ttname"><a href="group__GPIO.html#gaf8c939f31700c6e92bcd0ff728f8e7af">drv_gpio_register_isr_callback</a></div><div class="ttdeci">void drv_gpio_register_isr_callback(OM_GPIO_Type *om_gpio, drv_isr_callback_t isr_cb)</div><div class="ttdoc">Register event callback for GPIO interrupt.</div></div>
<div class="ttc" id="agroup__GPIO_html_ggacb840e4e0c59780df42ed0797e3d58b3a59bfac55a93a36f16c8c0bbced25c4d6"><div class="ttname"><a href="group__GPIO.html#ggacb840e4e0c59780df42ed0797e3d58b3a59bfac55a93a36f16c8c0bbced25c4d6">GPIO_TRIG_RISING_FAILING_EDGE</a></div><div class="ttdeci">@ GPIO_TRIG_RISING_FAILING_EDGE</div><div class="ttdoc">GPIO trigger type is both edge.</div><div class="ttdef"><b>Definition:</b> drv_gpio.h:69</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md83"></a>
Soft Event Timer</h1>
<h2><a class="anchor" id="autotoc_md84"></a>
Overview</h2>
<p>The implementation of the soft timer is similar to the soft timer in RTOS. It is based on hardware 32k timer, so it can run in sleep.</p>
<h2><a class="anchor" id="autotoc_md85"></a>
Useful Function</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Function   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="group__EVT__TIMER.html#gaa6fa3e4b64c97f391c61dbb3ba40a359">evt_timer_set</a>   </td><td class="markdownTableBodyNone">Create a thread safety soft timer    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="group__EVT__TIMER.html#gac497600a77a3041e7724b85830b112ce">evt_timer_del</a>   </td><td class="markdownTableBodyNone">Delete a thread safety soft timer   </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
</div>
</body>
</html>
