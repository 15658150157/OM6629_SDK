<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<!-- BEGIN opengraph metadata -->
<meta property="og:title" content="Doxygen Awesome" />
<meta property="og:image" content="https://repository-images.githubusercontent.com/348492097/4f16df80-88fb-11eb-9d31-4015ff22c452" />
<meta property="og:description" content="Custom CSS theme for doxygen html-documentation with lots of customization parameters." />
<meta property="og:url" content="https://jothepro.github.io/doxygen-awesome-css/" />
<!-- END opengraph metadata -->
<!-- BEGIN twitter metadata -->
<meta name="twitter:image:src" content="https://repository-images.githubusercontent.com/348492097/4f16df80-88fb-11eb-9d31-4015ff22c452" />
<meta name="twitter:title" content="Doxygen Awesome" />
<meta name="twitter:description" content="Custom CSS theme for doxygen html-documentation with lots of customization parameters." />
<!-- END twitter metadata -->
<title>User Guide: Secure Boot</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" type="image/svg+xml" href="logo.drawio.svg"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/
<a href="https://github.com/jothepro/doxygen-awesome-css" class="github-corner" title="View source on GitHub" target="_blank">
    <svg viewBox="0 0 250 250" width="40" height="40" style="position: absolute; top: 0; border: 0; right: 0; z-index: 99;" aria-hidden="true">
    <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
-->
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">User Guide
   </div>
   <div id="projectbrief">Bluetooth Low Energy 5.4</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('SECUREBOOT.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Secure Boot </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_doxygen_source_user_guides_secureboot"></a></p>
<h1><a class="anchor" id="autotoc_md28"></a>
Feature</h1>
<ul>
<li>Integrity verification of the firmware image</li>
<li>Authenticity verification of the firmware image using ECDSA</li>
<li>Support firmware anti-rollback</li>
<li>Secure Debug</li>
<li>Secure Upgrade</li>
</ul>
<h1><a class="anchor" id="autotoc_md29"></a>
Flash Partition</h1>
<div class="image">
<img src="flash_partition.png" alt=""/>
<div class="caption">
Flash Partition</div></div>
    <p>From romboot's perspective, Flash is divided into five regions: System Info, OPTION, MBR0, MBR1, and APP, which are described below</p>
<ul>
<li>System Info: used to store System Info data. Only when the Flash encryption function is turned off, the real content can be read out</li>
<li>OPTION: used to store the flags to control the chip. At present, two flags are provided, respectively occupying the first two bytes of the OPTION area. If the first byte is 0xFF, the chip is in the unlocked state, otherwise it is in the locked state. If the second byte is 0xFF, Flash encryption is turned off, otherwise, Flash encryption is turned on.</li>
<li>MBR0: used to store the configuration information of Flash and the manifest of APP. The specific content is shown in the figure, where Flash information occupies the first page of MBR0 (256B), and the manifest of APP occupies the second page of MBR0 (256B).</li>
<li>MBR1: this store has the same content type as MBR0, but is used in the upgrade process. If MBR1 is present and the validation passes, romboot will proceed to the program upgrade process</li>
<li>APP: used to store user programs</li>
</ul>
<h1><a class="anchor" id="autotoc_md30"></a>
Efuse Partition</h1>
<div class="image">
<img src="efuse_partition.png" alt=""/>
<div class="caption">
Efuse Partition</div></div>
    <p>EFUSE has a total of 512bits, and several bits of the above efuse are manipulated when romboot turns on the security function</p>
<ul>
<li>bit496: used to control whether the security function is enabled or not. 0: turn off the security function 1: turn on the security function</li>
<li>bit240-bit495: valid when security is turned on, used to store a 256-bits hash of public key as the Root of Trust of the whole system</li>
<li>bit497: used to control the swd debug interface. 0: turn on swd 1: turn off swd</li>
<li>bit498: used to control whether the secureboot function is enabled. 0: turn off secureboot 1: turn on secureboot</li>
<li>bit499~bit500: used to set the waiting time for Flash to power up and stabilize. 0: waiting 500ms 1: waiting 200ms 2: waiting 500ms 3: no waiting</li>
</ul>
<h1><a class="anchor" id="autotoc_md31"></a>
ISP/BOOT Mode</h1>
<p>There are two modes in romboot: ISP mode and BOOT mode</p>
<ul>
<li>BOOT mode: according to the parameters in Efuse and Flash, jump to the specified location to execute the program.</li>
<li>ISP mode: in this mode, a series of commands are provided, based on these commands, you can download the firmware to chip Flash, switch SWD, set the communication rate, etc.</li>
</ul>
<h2><a class="anchor" id="autotoc_md32"></a>
Boot Mode</h2>
<div class="image">
<img src="boot_mode.png" alt=""/>
<div class="caption">
Boot Mode</div></div>
    <ol type="1">
<li>Check the boot pin(PAD4) power-on latch level, if it is low, enter ISP mode， otherwise, enter BOOT mode</li>
<li>In BOOT mode, the content in EFUSE is read to check whether the security function is enabled. If it is not enabled, no security check is done, and the system will directly jump to the specified address to execute the program</li>
<li>When the security function is enabled, the public key HASH in EFUSE is read and verified with the public key in Image Manifest. If the verification fails, the system is reset</li>
<li>When the public key verification is successful, ECDSA is used to verify the signature in Image Mainfest to check the authenticity, and if the verification fails, the system is reset</li>
<li>When the authenticity check of Image Mainfest passes, the hash of the firmware is calculated and compared with the hash in Image Manifest, that is, the integrity of the firmware is checked</li>
<li>When the above checks for secure boot are passed, the system will jump to the specified address to execute the application</li>
</ol>
<h2><a class="anchor" id="autotoc_md33"></a>
ISP Mode</h2>
<div class="image">
<img src="isp_mode.png" alt=""/>
<div class="caption">
ISP Mode</div></div>
    <p>As mentioned above, when the boot pin is low when the system is powered on, the system will enter the ISP mode. In this mode, a set of commands are provided for the PC to control the chip through the serial port, such as downloading programs, <a class="el" href="SECUREBOOT.html#sc_secure_debug">secure debug</a>, setting the communication rate and other functions. For the specific supported commands, please refer to the <a class="el" href="SECUREBOOT.html#sc_communication_protocol">Communication Protocol</a> chapter.</p>
<h1><a class="anchor" id="sc_secure_debug"></a>
Secure Debug</h1>
<p>For security reasons, such as protecting user code from being stolen and sensitive information from being exposed, after enabling the protection function, the commands supported in ISP mode and SWD interface will be limited. The following two situations are explained: opening and closing the security function.</p>
<div class="image">
<img src="debug_sc_dis.png" alt=""/>
<div class="caption">
Debug(Security Off)</div></div>
    <p>When the security function is turned off, you can use the command <code>lock</code> in ISP mode to lock the chip. Once the lock is successfully applied, the SWD interface is closed, and the commands <b>write, read, erase, and reboot</b> in ISP mode will be disabled. In this way, it is impossible to debug or read or modify any content inside the chip from the outside. If you want to re-open SWD or obtain the permission to use all commands in ISP mode, you can only unlock the chip by command <code>lock</code>, but when the unlock is successful, the internal Flash content from the second sector to the end will be erased. This ensures that the user's data is not stolen by the outside world after being protected.</p>
<div class="image">
<img src="debug_sc_en.png" alt=""/>
<div class="caption">
Debug(Security On)</div></div>
    <p>When the security function is turned on, that is, the HASH of the public key is written in Efuse, the chip is in Normal state by default, and the commands <b>write, read, erase, reboot</b> in ISP mode will be disabled. When the SWD control bit(bit497) is written to EFUSE, SWD will be turned off forever. After the above steps, the outside world cannot debug or read or modify anything inside the chip. If you want to reopen SWD or get permissions used by all commands in ISP mode, you need to get ROOT permissions, and how to get ROOT permissions: In ISP mode, use auth challenge to obtain a random number, sign it with the private key, and use auth response to verify it. If the verification is successful, the root permission is obtained, and the right to use all commands in ISP mode is obtained. It is worth noting that the control bit of the SWD in EFUSE has been written dead, and the SWD interface will be closed each time the power is repowered.</p>
<h1><a class="anchor" id="autotoc_md34"></a>
Secure Upgrade</h1>
<div class="image">
<img src="rom_upgrade.png" alt=""/>
<div class="caption">
Upgrade Mode</div></div>
    <ol type="1">
<li>Check the boot pin(IO4) and enter ISP mode if it is low</li>
<li>Check if MBR1 is valid and enter BOOT mode if it is not</li>
<li>Check whether the hash of the firmware to be upgraded as described in MBR1 is correct, that is, check the integrity</li>
<li>Check whether the security function is turned on, if not, go directly to step 6</li>
<li>When security is enabled, the signature and version of MBR1 must also be checked (anti-rollback)</li>
<li>Transfer the firmware to be upgraded to the specified executing location</li>
<li>When everything is ready, the system is restarted, then, the upgraded program is executed</li>
</ol>
<h1><a class="anchor" id="sc_communication_protocol"></a>
Communication Protocol</h1>
<h2><a class="anchor" id="autotoc_md35"></a>
Frame Format</h2>
<div class="image">
<img src="rom_frame_fmt.png" alt=""/>
<div class="caption">
Frame Format</div></div>
    <p>The above figure shows the communication protocol between the PC and the bootloader's serial port. Each frame consists of five parts: frame head (Preamble), data length (Payload len), data (Paylaod), frame end (Postamble), and check code (BCC).</p>
<p>DLE(0x10) is used as an escape character to distinguish ordinary data from special data (Preamble, Postamble). When the next byte of DLE is STX(0x02, start of text), it means the beginning of a frame is encountered. When the next byte after DLE is ETX(0x03, end of text), it indicates the end of a frame. When the next byte after DLE is still DLE(0x10), that is, when 'DLE DLE' is encountered, it represents a byte of normal data 0x10.</p>
<p>Payload len represents the length of the transferred data and consists of two bytes, with the higher bytes being sent first and the lower bytes being sent later.</p>
<p>BCC is the result of the XOR of each byte of the two parts of <code>Payload len</code> and <code>Payload</code>, which is used to check whether there is a data error during data transmission. It is worth noting that when organizing the data to be sent, when 0x10(DLE) appears in the three parts of Payload len, payload, BCC, it needs to be supplemented with a DLE in front of it. When parsing the received data, if you encounter 0x10(DLE) in Payload len, Payload, BCC, you need to remove one byte of DLE. <b>The contents involved in BCC calculation do not include DLE in Payload len and Payload</b>.</p>
<h2><a class="anchor" id="autotoc_md36"></a>
Payload Composition</h2>
<div class="image">
<img src="rom_payload.png" alt=""/>
<div class="caption">
Payload</div></div>
    <p>The request sent by the PC to bootloader consists of opcode (command ID) and its subsequent parameters. The response returned by bootloader consists of error code errno and response parameters. All parameters are stored in little-endian format. The commands and parameters supported by bootloader are listed in the opcode list.</p>
<h2><a class="anchor" id="autotoc_md37"></a>
Command List</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Command   </th><th class="markdownTableHeadLeft">Type   </th><th class="markdownTableHeadLeft">Value   </th><th class="markdownTableHeadLeft">Length   </th><th class="markdownTableHeadLeft">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">get info   </td><td class="markdownTableBodyLeft">opcode   </td><td class="markdownTableBodyLeft">0x0   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft">get device information    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">errno   </td><td class="markdownTableBodyLeft">errno   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft"><a class="el" href="SECUREBOOT.html#sc_error_code">error code</a>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">rsp0   </td><td class="markdownTableBodyLeft">info_ver   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft">version of the info type    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">rsp1   </td><td class="markdownTableBodyLeft">rom_ver   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft">version of bootloader    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">rsp2   </td><td class="markdownTableBodyLeft">root   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft">user permission<br  />
0: normal<br  />
1: root    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">rsp3   </td><td class="markdownTableBodyLeft">swd_status   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft">debug interface state<br  />
0: disable<br  />
1: enable    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">rsp4   </td><td class="markdownTableBodyLeft">dev_ver   </td><td class="markdownTableBodyLeft">4B   </td><td class="markdownTableBodyLeft">version of device    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">rsp5   </td><td class="markdownTableBodyLeft">flash_id   </td><td class="markdownTableBodyLeft">4B   </td><td class="markdownTableBodyLeft">inner flash ID    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">rsp6   </td><td class="markdownTableBodyLeft">feature   </td><td class="markdownTableBodyLeft">4B   </td><td class="markdownTableBodyLeft">bootloader's feature    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">set baudrate   </td><td class="markdownTableBodyLeft">opcode   </td><td class="markdownTableBodyLeft">0x01   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft">set uart baudrate    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">param0   </td><td class="markdownTableBodyLeft">baudrate   </td><td class="markdownTableBodyLeft">4B   </td><td class="markdownTableBodyLeft">baudrate    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">errno   </td><td class="markdownTableBodyLeft">errno   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft"><a class="el" href="SECUREBOOT.html#sc_error_code">error code</a>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">init   </td><td class="markdownTableBodyLeft">opcode   </td><td class="markdownTableBodyLeft">0x02   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft">system initialization    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">param0   </td><td class="markdownTableBodyLeft">init_exflash   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft">decide whether to initialize the external flash    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">errno   </td><td class="markdownTableBodyLeft">errno   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft"><a class="el" href="SECUREBOOT.html#sc_error_code">error code</a>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">erase   </td><td class="markdownTableBodyLeft">opcode   </td><td class="markdownTableBodyLeft">0x03   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft">erase flash    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">param0   </td><td class="markdownTableBodyLeft">erase_type   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft">erase type<br  />
0: erase_4K<br  />
1: erase_32k<br  />
2: erase_64k<br  />
3: erase_chip    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">param1   </td><td class="markdownTableBodyLeft">addr   </td><td class="markdownTableBodyLeft">4B   </td><td class="markdownTableBodyLeft">bus address to be erased    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">param2   </td><td class="markdownTableBodyLeft">len   </td><td class="markdownTableBodyLeft">4B   </td><td class="markdownTableBodyLeft">length to be erased    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">errno   </td><td class="markdownTableBodyLeft">errno   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft"><a class="el" href="SECUREBOOT.html#sc_error_code">error code</a>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">read   </td><td class="markdownTableBodyLeft">opcode   </td><td class="markdownTableBodyLeft">0x04   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft">read from flash/efuse/ram/registers    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">param0   </td><td class="markdownTableBodyLeft">addr   </td><td class="markdownTableBodyLeft">4B   </td><td class="markdownTableBodyLeft">bus address to be read    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">param1   </td><td class="markdownTableBodyLeft">len   </td><td class="markdownTableBodyLeft">4B   </td><td class="markdownTableBodyLeft">length to be read    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">errno   </td><td class="markdownTableBodyLeft">errno   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft"><a class="el" href="SECUREBOOT.html#sc_error_code">error code</a>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">rsp0   </td><td class="markdownTableBodyLeft">rd_data   </td><td class="markdownTableBodyLeft">len B   </td><td class="markdownTableBodyLeft">data    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">write   </td><td class="markdownTableBodyLeft">opcode   </td><td class="markdownTableBodyLeft">0x05   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft">write to flash/efuse/ram/registers    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">param0   </td><td class="markdownTableBodyLeft">addr   </td><td class="markdownTableBodyLeft">4B   </td><td class="markdownTableBodyLeft">bus address to be written    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">param1   </td><td class="markdownTableBodyLeft">len   </td><td class="markdownTableBodyLeft">4B   </td><td class="markdownTableBodyLeft">length to be written    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">param2   </td><td class="markdownTableBodyLeft">wr_data   </td><td class="markdownTableBodyLeft">len B   </td><td class="markdownTableBodyLeft">data to be written    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">errno   </td><td class="markdownTableBodyLeft">errno   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft"><a class="el" href="SECUREBOOT.html#sc_error_code">error code</a>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">rsp0   </td><td class="markdownTableBodyLeft">block_info   </td><td class="markdownTableBodyLeft">4B   </td><td class="markdownTableBodyLeft">block information used to manage flash downloads    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">verify   </td><td class="markdownTableBodyLeft">opcode   </td><td class="markdownTableBodyLeft">0x06   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft">verify the contents of the specified address    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">param0   </td><td class="markdownTableBodyLeft">verify_type   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft">verify type<br  />
0: using SHA256<br  />
1: using CRC32    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">param1   </td><td class="markdownTableBodyLeft">addr   </td><td class="markdownTableBodyLeft">4B   </td><td class="markdownTableBodyLeft">bus address to be verified    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">param2   </td><td class="markdownTableBodyLeft">len   </td><td class="markdownTableBodyLeft">4B   </td><td class="markdownTableBodyLeft">lenth to be verified    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">errno   </td><td class="markdownTableBodyLeft">errno   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft"><a class="el" href="SECUREBOOT.html#sc_error_code">error code</a>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">rsp0   </td><td class="markdownTableBodyLeft">result   </td><td class="markdownTableBodyLeft">4/32B   </td><td class="markdownTableBodyLeft">result    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">reboot   </td><td class="markdownTableBodyLeft">opcode   </td><td class="markdownTableBodyLeft">0x07   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft">execute from the specified address    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">param0   </td><td class="markdownTableBodyLeft">addr   </td><td class="markdownTableBodyLeft">4B   </td><td class="markdownTableBodyLeft">address    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">errno   </td><td class="markdownTableBodyLeft">errno   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft"><a class="el" href="SECUREBOOT.html#sc_error_code">error code</a>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">auth challenge   </td><td class="markdownTableBodyLeft">opcode   </td><td class="markdownTableBodyLeft">0x08   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft">challenge of authentication    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">errno   </td><td class="markdownTableBodyLeft">errno   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft"><a class="el" href="SECUREBOOT.html#sc_error_code">error code</a>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">rsp0   </td><td class="markdownTableBodyLeft">random   </td><td class="markdownTableBodyLeft">32B   </td><td class="markdownTableBodyLeft">random    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">auth response   </td><td class="markdownTableBodyLeft">opcode   </td><td class="markdownTableBodyLeft">0x09   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft">authentication    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">param0   </td><td class="markdownTableBodyLeft">signature   </td><td class="markdownTableBodyLeft">32B   </td><td class="markdownTableBodyLeft">signature of the obtained random number    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">param1   </td><td class="markdownTableBodyLeft">public key   </td><td class="markdownTableBodyLeft">64B   </td><td class="markdownTableBodyLeft">public key    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">errno   </td><td class="markdownTableBodyLeft">errno   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft"><a class="el" href="SECUREBOOT.html#sc_error_code">error code</a>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">lock   </td><td class="markdownTableBodyLeft">opcode   </td><td class="markdownTableBodyLeft">0x0A   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft">lock/unlock chip    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">param0   </td><td class="markdownTableBodyLeft">enable   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft">control<br  />
0: unlock<br  />
1: lock    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">errno   </td><td class="markdownTableBodyLeft">errno   </td><td class="markdownTableBodyLeft">1B   </td><td class="markdownTableBodyLeft"><a class="el" href="SECUREBOOT.html#sc_error_code">error code</a>   </td></tr>
</table>
<h2><a class="anchor" id="sc_error_code"></a>
Error Code</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Type   </th><th class="markdownTableHeadCenter">Value   </th><th class="markdownTableHeadCenter">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">OK   </td><td class="markdownTableBodyCenter">0   </td><td class="markdownTableBodyCenter">success    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">UNSPECIFIC   </td><td class="markdownTableBodyCenter">1   </td><td class="markdownTableBodyCenter">some unspecified error occurred    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">TIMEOUT   </td><td class="markdownTableBodyCenter">3   </td><td class="markdownTableBodyCenter">timeout error, such as receiving an incomplete or incorrect command frame    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">UNSUPPORTED   </td><td class="markdownTableBodyCenter">4   </td><td class="markdownTableBodyCenter">feature not supported    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">PARAMETER   </td><td class="markdownTableBodyCenter">5   </td><td class="markdownTableBodyCenter">wrong parameter was specified    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">RESOURCES   </td><td class="markdownTableBodyCenter">6   </td><td class="markdownTableBodyCenter">there are no required resources or hardware, for example mbr0 does not exist    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">PERMISSION   </td><td class="markdownTableBodyCenter">7   </td><td class="markdownTableBodyCenter">commands that require root privileges cannot be executed in the normal state    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">OUT OF RANGE   </td><td class="markdownTableBodyCenter">8   </td><td class="markdownTableBodyCenter">the specified address is out of range    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">STATUS   </td><td class="markdownTableBodyCenter">10   </td><td class="markdownTableBodyCenter">state error, e.g., some commands cannot be used in a non-secure state   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md38"></a>
Tool</h1>
<p>To facilitate users to generate image for execution or upgrade, the <code>imgutis tools</code> for windows and linux are available in the <code>SDK/tools/imgutils</code> directory. The windows tools are described below.</p>
<ul>
<li>Supported Commands</li>
</ul>
<div class="fragment"><div class="line">PS C:\Users&gt; .\imgutils.exe --help</div>
<div class="line">Usage: imgutils.exe [OPTIONS] COMMAND [ARGS]...</div>
<div class="line"> </div>
<div class="line">Options:</div>
<div class="line">  --help  Show this message and exit.</div>
<div class="line"> </div>
<div class="line">Commands:</div>
<div class="line">  gen_img      Gnerate image for downloading or upgrading</div>
<div class="line">  gen_keypair  Gnerate ECDSA key pair(random)</div>
<div class="line">  gen_pubkey   Gnerate Public key from ECDSA private key</div>
<div class="line">  merge        Merge IntelHex files to one file(ELF/HEX/BIN)</div>
</div><!-- fragment --><ul>
<li><p class="startli">Generate public and private keys (only needed if the chip has security enabled)</p><ul>
<li>Generate a public-private key pair</li>
</ul>
<div class="fragment"><div class="line">.\imgutils.exe gen_keypair -f PEM</div>
</div><!-- fragment --><p class="startli">This command will generate public/private key pair in the current directory in both <code>.c</code> and <code>.pem</code> formats.</p><ul>
<li>Generate public key or hash of public key</li>
</ul>
<div class="fragment"><div class="line">.\imgutils.exe gen_pubkey -i private_key.pem -o public_key.c</div>
</div><!-- fragment --><p class="startli">This command will generate public key from the private key in the format specified by the file extension. When <code>-o xx.hash</code> appears, it will generate hash file corresponding to the public key.</p>
</li>
<li>Generate image for upgrade or execution</li>
</ul>
<div class="fragment"><div class="line">PS C:\Users&gt; .\imgutils.exe gen_img --help</div>
<div class="line">Usage: imgutils.py gen_img [OPTIONS]</div>
<div class="line"> </div>
<div class="line">  Generate image for downloading or upgrading</div>
<div class="line"> </div>
<div class="line">Options:</div>
<div class="line">  -c, --config TEXT</div>
<div class="line">  -a, --application_hex TEXT</div>
<div class="line">  -k, --private_key TEXT</div>
<div class="line">  --load_addr HEX</div>
<div class="line">  -o, --output_hex TEXT</div>
<div class="line">  --help                      Show this message and exit.</div>
</div><!-- fragment --><p><code>-c</code> specifies yaml configuration file, which is used to set the frequency of Flash, read and write command, and program version number. The specific parameters are as follows:</p>
<div class="fragment"><div class="line"># config.yaml</div>
<div class="line"> </div>
<div class="line">iflash_config:</div>
<div class="line">  clk_div: 0</div>
<div class="line">  delay: 0xFF</div>
<div class="line">  read_cmd: &#39;FLASH_FAST_READ_QIO&#39;</div>
<div class="line">  write_cmd: &#39;FLASH_PAGE_PROGRAM&#39;</div>
<div class="line">  spi_mode: &#39;SPI_MODE_0&#39;</div>
<div class="line">  encrypt_en: 0       # NOT USED</div>
<div class="line"># optional arguments to read cmd are FLASH_READ，FLASH_FAST_READ，FLASH_FAST_READ_DO，FLASH_FAST_READ_DIO，FLASH_FAST_READ_QO，FLASH_FAST_READ_QIO</div>
<div class="line"># argument to write cmd only supports FLASH PAGE PROGRAM</div>
<div class="line"># encrypt_en parameter is currently deprecated</div>
<div class="line"> </div>
<div class="line">manifest_config:</div>
<div class="line">  img_ver: 2</div>
</div><!-- fragment --><p><code>-a</code> specifies the user's application firmware and only supports hex files.</p>
<p><code>-k</code> specifies the private key file. Both <code>.c</code> and <code>.pem</code> formats are supported. Only required if chip security is enabled.</p>
<p><code>--load_addr</code> specifies the location of the firmware. This is only required when generating firmware for upgrade. When not specified, the location of the firmware is the execution address of the firmware.</p>
<p><code>-o</code> specifies the final output file, only hex file format is supported</p>
<ul>
<li>Merge single or multiple hex files into a single elf/hex/bin file</li>
</ul>
<div class="fragment"><div class="line">PS C:\Users&gt; .\imgutils.exe merge test1.hex test2.hex test3.hex -o test.elf</div>
</div><!-- fragment --><p>Currently support output elf, hex, bin three formats, different formats according to the file suffix is distinguished. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
</div>
</body>
</html>
